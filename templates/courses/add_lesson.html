<!-- templates/courses/add_lesson.html -->
{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}–î–æ–¥–∞—ò –ª–µ–∫—Ü–∏—ò–∞ - {{ course.title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h4 class="mb-0"><i class="bi bi-plus-circle me-2"></i>–î–æ–¥–∞—ò –Ω–æ–≤–∞ –ª–µ–∫—Ü–∏—ò–∞</h4>
                    <small class="text-muted">{{ course.title }}</small>
                </div>
                <div class="card-body">

                    {% if form.non_field_errors %}
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <strong>–ì—Ä–µ—à–∫–∞:</strong>
                            <ul class="mb-0 mt-2">
                                {% for error in form.non_field_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endif %}


                    <div id="validation-errors" class="alert alert-danger alert-dismissible fade show" role="alert" style="display: none;">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <strong>–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∫—Ä–µ–∏—Ä–∞—ö–µ –Ω–∞ –ª–µ–∫—Ü–∏—ò–∞:</strong>
                        <ul id="error-list" class="mb-0 mt-2"></ul>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>

                    <form method="post" enctype="multipart/form-data" id="lesson-form">
                        {% csrf_token %}
                        {{ form|crispy }}

                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'courses:manage' course.slug %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-2"></i>–ù–∞–∑–∞–¥
                            </a>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-plus-circle me-2"></i>–î–æ–¥–∞—ò –ª–µ–∫—Ü–∏—ò–∞
                            </button>
                        </div>
                    </form>
                </div>
            </div>

           <!-- Help Card -->
<div class="card shadow-sm mt-3">
    <div class="card-header">
        <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>–°–æ–≤–µ—Ç–∏ –∑–∞ —Å–æ–∑–¥–∞–≤–∞—ö–µ –ª–µ–∫—Ü–∏–∏</h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <h6><i class="bi bi-play-circle text-primary me-2"></i>–í–∏–¥–µ–æ –ª–µ–∫—Ü–∏–∏</h6>
                <ul class="small">
                    <li>–í–Ω–µ—Å–µ—Ç–µ YouTube/Vimeo URL –∏–ª–∏ –ø—Ä–∏–∫–∞—á–µ—Ç–µ —Ñ–∞—ò–ª</li>
                    <li><strong>–ó–∞–¥–æ–ª–∂–∏—Ç–µ–ª–Ω–æ:</strong> –î–æ–¥–∞–¥–µ—Ç–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –∏–ª–∏ –±–µ–ª–µ—à–∫–∏ (–º–∏–Ω–∏–º—É–º 250 –∑–±–æ—Ä–æ–≤–∏)</li>
                    <li>–û–ø—Ç–∏–º–∞–ª–Ω–∞ –¥–æ–ª–∂–∏–Ω–∞: 5-15 –º–∏–Ω—É—Ç–∏</li>
                </ul>
            </div>
            <div class="col-md-4">
                <h6><i class="bi bi-file-text text-success me-2"></i>–¢–µ–∫—Å—Ç –ª–µ–∫—Ü–∏–∏</h6>
                <ul class="small">
                    <li>–ü–æ–ø–æ–ª–Ω–µ—Ç–µ –≥–æ –ø–æ–ª–µ—Ç–æ "–°–æ–¥—Ä–∂–∏–Ω–∞"</li>
                    <li><strong>–ú–∏–Ω–∏–º—É–º 250 –∑–±–æ—Ä–æ–≤–∏</strong> </li>
                    <li>–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–∞—ò—Ç–µ —ò–∞ —Å–æ–¥—Ä–∂–∏–Ω–∞—Ç–∞</li>
                </ul>
            </div>
            <div class="col-md-4">
                <h6><i class="bi bi-file-pdf text-danger me-2"></i>PDF –ª–µ–∫—Ü–∏–∏</h6>
                <ul class="small">
                    <li>–ü—Ä–∏–∫–∞—á–µ—Ç–µ PDF –¥–æ–∫—É–º–µ–Ω—Ç</li>
                    <li>–ú–∞–∫—Å–∏–º–∞–ª–Ω–∞ –≥–æ–ª–µ–º–∏–Ω–∞: 10MB</li>
                </ul>
            </div>
        </div>
    </div>
</div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('lesson-form');
    const lessonTypeField = document.getElementById('id_lesson_type');
    const videoUrlField = document.getElementById('id_video_url');
    const videoFileField = document.getElementById('id_video_file');
    const pdfFileField = document.getElementById('id_pdf_file');
    const contentField = document.getElementById('id_content');
    const errorAlert = document.getElementById('validation-errors');
    const errorList = document.getElementById('error-list');

    // üÜï –§—É–Ω–∫—Ü–∏—ò–∞ –∑–∞ enable/disable –Ω–∞ –ø–æ–ª–∏—ö–∞ —Å–ø–æ—Ä–µ–¥ —Ç–∏–ø–æ—Ç
    function updateFieldsAvailability() {
        const lessonType = lessonTypeField.value;

        // Reset–∏—Ä–∞—ò —Å√®
        [videoUrlField, videoFileField, pdfFileField, contentField].forEach(field => {
            if (field) {
                field.disabled = false;
                field.required = false;
                const wrapper = field.closest('.mb-3') || field.closest('.form-group');
                if (wrapper) {
                    wrapper.classList.remove('border', 'border-primary', 'border-success', 'border-danger',
                                           'border-warning', 'border-2', 'p-3', 'rounded', 'bg-light', 'opacity-50');
                    wrapper.style.opacity = '1';
                }
            }
        });

        if (lessonType === 'video') {
            // ‚úÖ –í–∏–¥–µ–æ: –°–∞–º–æ –≤–∏–¥–µ–æ URL/—Ñ–∞—ò–ª + —Ç–µ–∫—Å—Ç (–∑–∞–¥–æ–ª–∂–∏—Ç–µ–ª–µ–Ω)
            // –û–≤–æ–∑–º–æ–∂–∏: video URL, video file, content
            contentField.required = true;

            // –û–Ω–µ–≤–æ–∑–º–æ–∂–∏: PDF
            if (pdfFileField) {
                pdfFileField.disabled = true;
                pdfFileField.value = '';
                const wrapper = pdfFileField.closest('.mb-3') || pdfFileField.closest('.form-group');
                if (wrapper) {
                    wrapper.classList.add('opacity-50');
                    wrapper.style.opacity = '0.5';
                }
            }

            // Highlight –∞–∫—Ç–∏–≤–Ω–∏ –ø–æ–ª–∏—ö–∞
            [videoUrlField, videoFileField, contentField].forEach(field => {
                if (field) {
                    const wrapper = field.closest('.mb-3') || field.closest('.form-group');
                    if (wrapper) {
                        wrapper.classList.add('border', 'border-primary', 'border-2', 'p-3', 'rounded', 'bg-light');
                    }
                }
            });

        } else if (lessonType === 'text') {
            // ‚úÖ –¢–µ–∫—Å—Ç: –°–∞–º–æ —Å–æ–¥—Ä–∂–∏–Ω–∞
            contentField.required = true;

            // –û–Ω–µ–≤–æ–∑–º–æ–∂–∏: video URL, video file, PDF
            [videoUrlField, videoFileField, pdfFileField].forEach(field => {
                if (field) {
                    field.disabled = true;
                    if (field.type === 'file') {
                        field.value = '';
                    } else {
                        field.value = '';
                    }
                    const wrapper = field.closest('.mb-3') || field.closest('.form-group');
                    if (wrapper) {
                        wrapper.classList.add('opacity-50');
                        wrapper.style.opacity = '0.5';
                    }
                }
            });

            // Highlight –∞–∫—Ç–∏–≤–Ω–æ –ø–æ–ª–µ
            if (contentField) {
                const wrapper = contentField.closest('.mb-3') || contentField.closest('.form-group');
                if (wrapper) {
                    wrapper.classList.add('border', 'border-success', 'border-2', 'p-3', 'rounded', 'bg-light');
                }
            }

        } else if (lessonType === 'pdf') {
            // ‚úÖ PDF: –°–∞–º–æ PDF —Ñ–∞—ò–ª
            if (pdfFileField) {
                pdfFileField.required = true;
            }

            // –û–Ω–µ–≤–æ–∑–º–æ–∂–∏: video URL, video file, content
            [videoUrlField, videoFileField, contentField].forEach(field => {
                if (field) {
                    field.disabled = true;
                    if (field.type === 'file') {
                        field.value = '';
                    } else {
                        field.value = '';
                    }
                    const wrapper = field.closest('.mb-3') || field.closest('.form-group');
                    if (wrapper) {
                        wrapper.classList.add('opacity-50');
                        wrapper.style.opacity = '0.5';
                    }
                }
            });

            // Highlight –∞–∫—Ç–∏–≤–Ω–æ –ø–æ–ª–µ
            if (pdfFileField) {
                const wrapper = pdfFileField.closest('.mb-3') || pdfFileField.closest('.form-group');
                if (wrapper) {
                    wrapper.classList.add('border', 'border-danger', 'border-2', 'p-3', 'rounded', 'bg-light');
                }
            }
        }

        // –ê–∂—É—Ä–∏—Ä–∞—ò word counter
        if (typeof updateWordCount === 'function') {
            updateWordCount();
        }
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—ò–∞ –ø—Ä–∏ submit
    form.addEventListener('submit', function(e) {
        const lessonType = lessonTypeField.value;
        const errors = [];

        if (lessonType === 'video') {
            if (!videoUrlField.value.trim() && (!videoFileField.files || videoFileField.files.length === 0)) {
                errors.push('–ó–∞ –≤–∏–¥–µ–æ –ª–µ–∫—Ü–∏–∏ –º–æ—Ä–∞—Ç–µ –¥–∞ –≤–Ω–µ—Å–µ—Ç–µ –≤–∏–¥–µ–æ URL –∏–ª–∏ –¥–∞ –ø—Ä–∏–∫–∞—á–∏—Ç–µ –≤–∏–¥–µ–æ —Ñ–∞—ò–ª.');
            }
            if (!contentField.value.trim()) {
                errors.push('–ó–∞ –≤–∏–¥–µ–æ –ª–µ–∫—Ü–∏–∏ –º–æ—Ä–∞ –¥–∞ –≤–Ω–µ—Å–µ—Ç–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –∏–ª–∏ –±–µ–ª–µ—à–∫–∏.');
            }
        } else if (lessonType === 'text') {
            if (!contentField.value.trim()) {
                errors.push('–ó–∞ —Ç–µ–∫—Å—Ç –ª–µ–∫—Ü–∏–∏ –º–æ—Ä–∞ –¥–∞ –≤–Ω–µ—Å–µ—Ç–µ —Å–æ–¥—Ä–∂–∏–Ω–∞.');
            }
        } else if (lessonType === 'pdf') {
            if (!pdfFileField.files || pdfFileField.files.length === 0) {
                errors.push('–ó–∞ PDF –ª–µ–∫—Ü–∏–∏ –º–æ—Ä–∞ –¥–∞ –ø—Ä–∏–∫–∞—á–∏—Ç–µ PDF –¥–æ–∫—É–º–µ–Ω—Ç.');
            }
        }

        if (errors.length > 0) {
            e.preventDefault();
            errorList.innerHTML = '';
            errors.forEach(error => {
                const li = document.createElement('li');
                li.textContent = error;
                errorList.appendChild(li);
            });
            errorAlert.style.display = 'block';
            errorAlert.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return false;
        } else {
            errorAlert.style.display = 'none';
        }
    });

    // Event listener –∑–∞ –ø—Ä–æ–º–µ–Ω–∞ –Ω–∞ —Ç–∏–ø
    if (lessonTypeField) {
        lessonTypeField.addEventListener('change', function() {
            updateFieldsAvailability();
            errorAlert.style.display = 'none';
        });
        updateFieldsAvailability(); // Initial call
    }

    // üÜï Word Counter
    if (contentField) {
        const wordCountDiv = document.createElement('div');
        wordCountDiv.className = 'form-text mt-2 fw-bold';
        wordCountDiv.id = 'word-count-display';
        contentField.parentElement.appendChild(wordCountDiv);

        function updateWordCount() {
            const text = contentField.value.trim();
            const wordCount = text ? text.split(/\s+/).filter(word => word.length > 0).length : 0;
            const lessonType = lessonTypeField ? lessonTypeField.value : '';

            // –ü–æ–∫–∞–∂–∏ word counter —Å–∞–º–æ –∑–∞ video –∏ text —Ç–∏–ø–æ–≤–∏
            if ((lessonType === 'video' || lessonType === 'text') && !contentField.disabled) {
                const remaining = Math.max(0, 250 - wordCount);

                if (wordCount >= 250) {
                    wordCountDiv.innerHTML = `
                        <i class="bi bi-check-circle-fill text-success me-1"></i>
                        <span class="text-success">${wordCount} –∑–±–æ—Ä–æ–≤–∏</span> - –î–æ–≤–æ–ª–Ω–æ –∑–∞ AI –∫–≤–∏–∑ –≥–µ–Ω–µ—Ä–∏—Ä–∞—ö–µ! ‚ú®
                    `;
                } else if (wordCount > 0) {
                    wordCountDiv.innerHTML = `
                        <i class="bi bi-exclamation-triangle-fill text-warning me-1"></i>
                        <span class="text-warning">${wordCount} –∑–±–æ—Ä–æ–≤–∏</span> - –ü–æ—Ç—Ä–µ–±–Ω–∏ —É—à—Ç–µ <span class="text-danger">${remaining} –∑–±–æ—Ä–æ–≤–∏</span> –∑–∞ AI –∫–≤–∏–∑ ü§ñ
                    `;
                } else {
                    wordCountDiv.innerHTML = `
                        <i class="bi bi-info-circle me-1"></i>
                        –í–Ω–µ—Å–µ—Ç–µ –º–∏–Ω–∏–º—É–º <strong>250 –∑–±–æ—Ä–æ–≤–∏</strong> –∑–∞ –∞–≤—Ç–æ–º–∞—Ç—Å–∫–æ –≥–µ–Ω–µ—Ä–∏—Ä–∞—ö–µ –Ω–∞ –∫–≤–∏–∑ –ø—Ä–∞—à–∞—ö–∞
                    `;
                }
                wordCountDiv.style.display = 'block';
            } else {
                wordCountDiv.style.display = 'none';
            }
        }

        // Make updateWordCount globally accessible
        window.updateWordCount = updateWordCount;

        contentField.addEventListener('input', updateWordCount);
        if (lessonTypeField) {
            lessonTypeField.addEventListener('change', updateWordCount);
        }
        updateWordCount();
    }
});
</script>

<style>
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
}

.error-shake {
    animation: shake 0.5s;
}

/* –í–∏–∑—É–µ–ª–Ω–∞ –∏–Ω–¥–∏–∫–∞—Ü–∏—ò–∞ –∑–∞ disabled –ø–æ–ª–∏—ö–∞ */
.opacity-50 {
    opacity: 0.5;
    pointer-events: none;
}

/* Smooth transitions */
.mb-3, .form-group {
    transition: all 0.3s ease;
}
</style>
{% endblock %}